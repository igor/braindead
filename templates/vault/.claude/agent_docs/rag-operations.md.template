# RAG System Operations

<!-- Replace all {PLACEHOLDERS} with your actual infrastructure details -->

## Collection Registry

**SINGLE SOURCE OF TRUTH**: [rag-collections.yaml](rag-collections.yaml)

The YAML registry defines all collections, their source paths, ingest scripts, and recommended query parameters. Always consult this file for current collection state.

## Infrastructure

- **Host**: {RAG_HOST_DESCRIPTION}  # e.g., Mac Mini at hostname, localhost, remote server
- **MCP server**: Port {RAG_PORT}
- **Ollama version**: {OLLAMA_VERSION}
- **Embedding model**: {EMBEDDING_MODEL}
- **RAG path**: {RAG_PATH}

<!-- If using remote server, add connection details: -->
<!-- - **Connection**: ssh {SSH_HOST} -->
<!-- - **SSH user**: {SSH_USER} -->

## Operations Workflow

- **BEFORE any RAG operation**: Read `rag-collections.yaml` for current collection state
- **AFTER collection changes**: Update `rag-collections.yaml` immediately with new chunk counts, dates, or entries
- **Service check**: `{SERVICE_CHECK_COMMAND}` before operations  # e.g., pgrep -f mcp_server.py

## Quick Reference

### Health Check

```bash
# Check if MCP server is running and healthy
{HEALTH_CHECK_COMMAND}
# Example for remote with API key:
# curl -H 'X-API-Key: {API_KEY}' http://{RAG_HOST}:{RAG_PORT}/health

# Example for localhost:
# curl http://localhost:{RAG_PORT}/health
```

### Re-indexing Collections

```bash
# Re-index all collections
{REINDEX_ALL_COMMAND}

# Example for remote server:
# ssh {RAG_HOST} 'cd {RAG_PATH} && source venv/bin/activate && \
#   python scripts/ingest_vault.py && \
#   python scripts/ingest_collection2.py'

# Re-index single collection
{REINDEX_SINGLE_COMMAND}

# Example:
# ssh {RAG_HOST} 'cd {RAG_PATH} && source venv/bin/activate && python scripts/ingest_{COLLECTION}.py'
```

### Querying Collections

Use the MCP ChromaDB tool via Claude Code:

```
Tool: mcp__chroma__chroma_query_documents
Parameters:
  collection_name: {COLLECTION_NAME}
  query_texts: ["{YOUR_QUERY}"]
  n_results: {N_RESULTS}
```

Consult `rag-collections.yaml` for recommended n_results for each collection.

## Common Operations

### Starting the MCP Server

```bash
{START_SERVER_COMMAND}

# Example for remote:
# ssh {RAG_HOST} 'cd {RAG_PATH} && source venv/bin/activate && python mcp_server.py'

# Example for localhost:
# cd {RAG_PATH} && source venv/bin/activate && python mcp_server.py
```

### Stopping the MCP Server

```bash
{STOP_SERVER_COMMAND}

# Example:
# pkill -f mcp_server.py
```

### Checking Server Status

```bash
# Check if process is running
{STATUS_COMMAND}

# Example:
# pgrep -f mcp_server.py
```

### Viewing Server Logs

```bash
{LOG_COMMAND}

# Example:
# tail -f {RAG_PATH}/logs/mcp_server.log
```

## Adding a New Collection

1. **Create ingest script** at `{RAG_PATH}/scripts/ingest_{COLLECTION_NAME}.py`
2. **Create slash command** in `.claude/commands/{COLLECTION_NAME}.md`
3. **Update `rag-collections.yaml`** with new collection entry
4. **Run initial indexing** using the new ingest script
5. **Verify with health check** to ensure collection was created
6. **Update chunk/file counts** in `rag-collections.yaml` after indexing completes

## Troubleshooting

### Server not responding

1. Check if server process is running: `{STATUS_COMMAND}`
2. Check server logs: `{LOG_COMMAND}`
3. Restart server: `{STOP_SERVER_COMMAND} && {START_SERVER_COMMAND}`
4. Check network connectivity (if remote): `ping {RAG_HOST}`

### Collection not found

1. List all collections: Use MCP tool `mcp__chroma__chroma_list_collections`
2. Check `rag-collections.yaml` for collection name (case-sensitive)
3. Verify collection was indexed: Check logs or run health check

### Stale search results

1. Check `last_indexed` date in `rag-collections.yaml`
2. Re-index collection: `{REINDEX_SINGLE_COMMAND}`
3. Update `rag-collections.yaml` with new date and chunk counts

### Poor search quality

1. Try adjusting `n_results` (increase for more context)
2. Refine query to be more specific
3. Consider if another collection would be more appropriate
4. Check if sources need updating (for curated content collections)

## Maintenance Schedule

### Weekly
- Check server status and logs
- Monitor disk space at `{RAG_PATH}`

### Monthly
- Re-index frequently updated collections
- Review and update `rag-collections.yaml` documentation
- Clean up old embeddings if needed

### As Needed
- Re-index after major vault changes (100+ files)
- Add new collections when new domains emerge
- Update ingest scripts if chunking strategy changes

## Security Notes

<!-- Add any security considerations -->

- {SECURITY_NOTE_1}
- {SECURITY_NOTE_2}
- API keys stored in {API_KEY_LOCATION} (not in git)
- {ADDITIONAL_SECURITY_NOTES}

---

**For detailed collection information, always refer to:** [rag-collections.yaml](rag-collections.yaml)
